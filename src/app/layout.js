"use client";
import "./globals.css";
import { useState, useEffect, useRef } from "react";
import gsap from "gsap";
import { AppProgressBar as ProgressBar } from "next-nprogress-bar";
import LocomotiveScroll from "locomotive-scroll";
import { usePathname } from "next/navigation";
import TopButton from "@/components/TopButton";

function cursorInteraction() {
  const isTouchDevice =
    navigator.maxTouchPoints || "ontouchstart" in document.documentElement;
  let cursor = document.querySelector(".cursorBall");
  let cursorText = document.querySelector(".cursorText");
  const links = document.querySelectorAll("a");

  if (isTouchDevice === false) {
    document.addEventListener("mousemove", (e) => {
      cursor.style.top = e.clientY + "px";
      cursor.style.left = e.clientX + "px";
    });

    const onMouseEnterLink = () => {
      gsap.to(cursor, { scale: 4 });
      cursorText.style.display = "block";
    };

    const onMouseLeaveLink = () => {
      gsap.to(cursor, { scale: 1 });
      cursorText.style.display = "none";
    };

    const onMouseClickLink = () => {
      gsap.to(cursor, { scale: 1 });
      cursorText.style.display = "none";
    };

    links.forEach((link) => {
      link.addEventListener("mouseenter", onMouseEnterLink);
      link.addEventListener("mouseleave", onMouseLeaveLink);
      link.addEventListener("click", onMouseClickLink);
    });
  } else {
    cursor.style.display = "none";
  }
}

export default function RootLayout({ children }) {
  const [toTop, setToTop] = useState(false);
  const pathname = usePathname();
  const scrollRef = useRef(null);

  function toTopHandler() {
    setToTop(true);
  }

  useEffect(() => {
    cursorInteraction();

    const locomotiveScroll = new LocomotiveScroll();
    locomotiveScroll.scrollTo(".pageWrapper", {
      offset: 0,
      duration: 1,
      easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
      onComplete: () => {
        setToTop(false);
      },
    });
  }, [toTop]);

  return (
    <html lang="ko">
      <head>
        <title>Leesangdal Portfolio Website</title>
        <meta name="description" content="Generated by create next app" />
      </head>
      <body data-scroll-container ref={scrollRef}>
        <div className="cursorBall">
          <span className="cursorText">more</span>
        </div>
        <ProgressBar
          height="4px"
          color="#fff"
          options={{ showSpinner: true }}
          shallowRouting
        />
        {children}
        <TopButton toTop={toTopHandler} />
      </body>
    </html>
  );
}
